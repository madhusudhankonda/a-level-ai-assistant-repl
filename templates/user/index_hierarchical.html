{% extends 'base.html' %}

{% block title %}A-Level AI Assistant - Subjects{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">A-Level Subjects</h1>
                <!-- Buttons will be shown in the Tools section below -->
            </div>
            
            <!-- Quick Navigation with Dropdowns -->
            <div class="card mb-4">
                <div class="card-header bg-gradient-purple text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        Quick Paper Search
                    </h5>
                </div>
                <div class="card-body">
                    <form id="paperBrowserForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="subjectSelect" class="form-label">Subject</label>
                            <select id="subjectSelect" class="form-select">
                                <option value="">Select a subject...</option>
                                {% for subject in subjects %}
                                    {% if subject.name == 'Mathematics' %}
                                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% else %}
                                        <option value="" disabled title="Coming soon!">{{ subject.name }} (Coming Soon)</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="boardSelect" class="form-label">Exam Board</label>
                            <select id="boardSelect" class="form-select" disabled>
                                <option value="">Select an exam board...</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="categorySelect" class="form-label">Paper Category</label>
                            <select id="categorySelect" class="form-select" disabled>
                                <option value="">Select a paper category...</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="col-12 mt-4 text-center">
                            <button type="button" id="browseButton" class="btn btn-primary" disabled>
                                <i class="fas fa-search me-2"></i> Browse Papers
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- This space intentionally left empty after removing the "Recently Added Papers" section -->
            
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">AI Tools</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100 border-primary">
                                <div class="card-body text-center">
                                    <h5 class="card-title mb-3">
                                        <i class="fas fa-camera me-1"></i> Snap & Solve
                                    </h5>
                                    <p class="card-text mb-4">
                                        Capture a question image and get an instant step-by-step explanation
                                    </p>
                                    <div class="sparkle-animation position-absolute" style="right: 10px; top: 10px; opacity: 0.7">
                                        <i class="fas fa-sparkles text-warning"></i>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <a href="{{ url_for('user.camera_capture') }}?mode=explanation-only" class="btn btn-primary btn-md d-block">
                                        <i class="fas fa-camera me-1"></i> Capture Question
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-success">
                                <div class="card-body text-center">
                                    <h5 class="card-title mb-3">
                                        <i class="fas fa-check-circle me-1"></i> Check My Work
                                    </h5>
                                    <p class="card-text mb-4">
                                        Upload your answer to receive personalized feedback and marking
                                    </p>
                                    <div class="sparkle-animation position-absolute" style="right: 10px; top: 10px; opacity: 0.7">
                                        <i class="fas fa-sparkles text-warning"></i>
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <a href="{{ url_for('user.camera_capture') }}?mode=answer-feedback" class="btn btn-success btn-md d-block">
                                        <i class="fas fa-upload me-1"></i> Upload Answer
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const subjectSelect = document.getElementById('subjectSelect');
        const boardSelect = document.getElementById('boardSelect');
        const categorySelect = document.getElementById('categorySelect');
        const browseButton = document.getElementById('browseButton');
        
        // Data for dropdowns (populated from server)
        const boardsData = [
            {% for board in boards %}
            {
                id: {{ board.id }},
                name: "{{ board.name }}",
                subjectId: {{ board.subject_id }}
            },
            {% endfor %}
        ];
        
        const categoriesData = [
            {% for category in categories %}
            {
                id: {{ category.id }},
                name: "{{ category.name }}",
                boardId: {{ category.board_id }}
            },
            {% endfor %}
        ];
        
        // Debug information
        console.log('Boards Data:', boardsData);
        console.log('Categories Data:', categoriesData);
        
        // Event Listeners
        subjectSelect.addEventListener('change', function() {
            const selectedSubjectId = parseInt(this.value);
            console.log('Selected Subject ID:', selectedSubjectId);
            
            // Clear and disable subsequent dropdowns
            clearDropdown(boardSelect, 'Select an exam board...');
            clearDropdown(categorySelect, 'Select a paper category...');
            browseButton.disabled = true;
            
            if (selectedSubjectId) {
                // Enable board dropdown and populate with filtered options
                boardSelect.disabled = false;
                
                // Filter boards by selected subject
                const filteredBoards = boardsData.filter(board => board.subjectId === selectedSubjectId);
                console.log('Filtered Boards:', filteredBoards);
                
                // Add options to board dropdown
                filteredBoards.forEach(board => {
                    const option = document.createElement('option');
                    option.value = board.id;
                    option.textContent = board.name;
                    boardSelect.appendChild(option);
                });
                
                // Auto-select AQA (ID: 1) for Mathematics if it exists
                if (selectedSubjectId === 1) {
                    let aqaOption = Array.from(boardSelect.options).find(option => option.value === "1");
                    if (aqaOption) {
                        boardSelect.value = "1";
                        // Trigger the change event to load categories
                        boardSelect.dispatchEvent(new Event('change'));
                    }
                }
            } else {
                // Disable all downstream selects
                boardSelect.disabled = true;
                categorySelect.disabled = true;
            }
        });
        
        boardSelect.addEventListener('change', function() {
            const selectedBoardId = parseInt(this.value);
            console.log('Selected Board ID:', selectedBoardId);
            
            // Clear and disable category dropdown
            clearDropdown(categorySelect, 'Select a paper category...');
            browseButton.disabled = true;
            
            if (selectedBoardId) {
                // Enable category dropdown and populate with filtered options
                categorySelect.disabled = false;
                
                // Filter categories by selected board
                const filteredCategories = categoriesData.filter(category => category.boardId === selectedBoardId);
                console.log('Filtered Categories:', filteredCategories);
                
                // Add options to category dropdown
                filteredCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                // Auto-select Pure Mathematics (ID: 1) for AQA if it exists
                if (selectedBoardId === 1) {
                    let pureMathsOption = Array.from(categorySelect.options).find(option => option.value === "1");
                    if (pureMathsOption) {
                        categorySelect.value = "1";
                        // Enable the browse button
                        browseButton.disabled = false;
                    }
                }
            } else {
                // Disable category select
                categorySelect.disabled = true;
            }
        });
        
        categorySelect.addEventListener('change', function() {
            // Enable browse button if a category is selected
            browseButton.disabled = !this.value;
        });
        
        browseButton.addEventListener('click', function() {
            const categoryId = categorySelect.value;
            if (categoryId) {
                console.log('Navigating to category ID:', categoryId);
                // Navigate to the selected category
                window.location.href = `/category/${categoryId}`;
            } else {
                console.error('No category selected');
            }
        });
        
        // Helper function to clear a dropdown and add a default option
        function clearDropdown(selectElement, defaultText) {
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultText;
            selectElement.appendChild(defaultOption);
        }
    });
</script>
{% endblock %}