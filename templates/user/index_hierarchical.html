{% extends 'base.html' %}

{% block title %}A-Level AI Assistant - Subjects{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">A-Level Subjects</h1>
                <div class="d-flex">
                    <a href="{{ url_for('user.camera_capture') }}?mode=explanation-only" class="btn btn-primary me-2">
                        <i class="fas fa-camera me-1"></i> Capture Question
                    </a>
                    <a href="{{ url_for('user.camera_capture') }}?mode=answer-feedback" class="btn btn-success">
                        <i class="fas fa-check-circle me-1"></i> Upload Your Answer
                    </a>
                </div>
            </div>
            
            <!-- Quick Navigation with Dropdowns -->
            <div class="card mb-4">
                <div class="card-header bg-gradient-purple text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        Quick Paper Search
                    </h5>
                </div>
                <div class="card-body">
                    <form id="paperBrowserForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="subjectSelect" class="form-label">Subject</label>
                            <select id="subjectSelect" class="form-select">
                                <option value="">Select a subject...</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="boardSelect" class="form-label">Exam Board</label>
                            <select id="boardSelect" class="form-select" disabled>
                                <option value="">Select an exam board...</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="categorySelect" class="form-label">Paper Category</label>
                            <select id="categorySelect" class="form-select" disabled>
                                <option value="">Select a paper category...</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="col-12 mt-4 text-center">
                            <button type="button" id="browseButton" class="btn btn-primary" disabled>
                                <i class="fas fa-search me-2"></i> Browse Papers
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Classic Selection with Cards -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Select a Subject</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for subject in subjects %}
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="card h-100 border-primary">
                                <div class="card-body text-center">
                                    <h5 class="card-title">{{ subject.name }}</h5>
                                    <p class="card-text text-muted small">{{ subject.description }}</p>
                                </div>
                                <div class="card-footer bg-light">
                                    <a href="{{ url_for('user.view_subject', subject_id=subject.id) }}" class="btn btn-outline-primary btn-sm d-block">
                                        Browse Past Papers
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Question Analysis Tools</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100 border-info">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-robot me-1"></i> AI Question Solver
                                        <span class="ms-2">
                                            <i class="fas fa-star text-warning"></i>
                                            <i class="fas fa-star text-warning"></i>
                                            <i class="fas fa-star text-warning"></i>
                                        </span>
                                    </h5>
                                    <p class="card-text">
                                        Take a photo of your question or upload an image file to receive an AI explanation.
                                    </p>
                                </div>
                                <div class="card-footer bg-light">
                                    <a href="{{ url_for('user.camera_capture') }}?mode=explanation-only" class="btn btn-outline-info btn-sm d-block">
                                        <i class="fas fa-robot me-1"></i> AI Explanation
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-success">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-robot me-1"></i> AI-Powered Answer Analysis
                                        <span class="ms-2">
                                            <i class="fas fa-star text-warning"></i>
                                            <i class="fas fa-star text-warning"></i>
                                            <i class="fas fa-star text-warning"></i>
                                        </span>
                                    </h5>
                                    <p class="card-text">
                                        Take a photo showing both the question and your answer to receive feedback on your work.
                                    </p>
                                </div>
                                <div class="card-footer bg-light">
                                    <a href="{{ url_for('user.camera_capture') }}?mode=answer-feedback" class="btn btn-outline-success btn-sm d-block">
                                        <i class="fas fa-robot me-1"></i> AI Feedback & Marking
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const subjectSelect = document.getElementById('subjectSelect');
        const boardSelect = document.getElementById('boardSelect');
        const categorySelect = document.getElementById('categorySelect');
        const browseButton = document.getElementById('browseButton');
        
        // Data for dropdowns (populated from server)
        const boardsData = [
            {% for board in boards %}
            {
                id: {{ board.id }},
                name: "{{ board.name }}",
                subjectId: {{ board.subject_id }}
            },
            {% endfor %}
        ];
        
        const categoriesData = [
            {% for category in categories %}
            {
                id: {{ category.id }},
                name: "{{ category.name }}",
                boardId: {{ category.board_id }}
            },
            {% endfor %}
        ];
        
        // Event Listeners
        subjectSelect.addEventListener('change', function() {
            const selectedSubjectId = parseInt(this.value);
            
            // Clear and disable subsequent dropdowns
            clearDropdown(boardSelect, 'Select an exam board...');
            clearDropdown(categorySelect, 'Select a paper category...');
            browseButton.disabled = true;
            
            if (selectedSubjectId) {
                // Enable board dropdown and populate with filtered options
                boardSelect.disabled = false;
                
                // Filter boards by selected subject
                const filteredBoards = boardsData.filter(board => board.subjectId === selectedSubjectId);
                
                // Add options to board dropdown
                filteredBoards.forEach(board => {
                    const option = document.createElement('option');
                    option.value = board.id;
                    option.textContent = board.name;
                    boardSelect.appendChild(option);
                });
            } else {
                // Disable all downstream selects
                boardSelect.disabled = true;
                categorySelect.disabled = true;
            }
        });
        
        boardSelect.addEventListener('change', function() {
            const selectedBoardId = parseInt(this.value);
            
            // Clear and disable category dropdown
            clearDropdown(categorySelect, 'Select a paper category...');
            browseButton.disabled = true;
            
            if (selectedBoardId) {
                // Enable category dropdown and populate with filtered options
                categorySelect.disabled = false;
                
                // Filter categories by selected board
                const filteredCategories = categoriesData.filter(category => category.boardId === selectedBoardId);
                
                // Add options to category dropdown
                filteredCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } else {
                // Disable category select
                categorySelect.disabled = true;
            }
        });
        
        categorySelect.addEventListener('change', function() {
            // Enable browse button if a category is selected
            browseButton.disabled = !this.value;
        });
        
        browseButton.addEventListener('click', function() {
            const categoryId = categorySelect.value;
            if (categoryId) {
                // Navigate to the selected category
                window.location.href = `/category/${categoryId}`;
            }
        });
        
        // Helper function to clear a dropdown and add a default option
        function clearDropdown(selectElement, defaultText) {
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultText;
            selectElement.appendChild(defaultOption);
        }
    });
</script>
{% endblock %}