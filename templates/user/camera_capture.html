{% extends "base.html" %}

{% block title %}Student Answer Feedback - A-Level AI Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h1 class="mb-4">Student Answer Feedback</h1>
        <p class="lead">Capture your work to get instant feedback and explanations</p>
        <div class="mb-3">
            <a href="{{ url_for('user.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Papers
            </a>
        </div>
        
        <!-- API Status Alert (hidden by default) -->
        <div id="api-status-alert" class="alert alert-warning mb-4" style="display: none;">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-circle me-2 fs-4"></i>
                <div>
                    <strong>API Status Check</strong>
                    <p id="api-status-message" class="mb-0">Checking OpenAI API connection...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Subject Selection and Mode Selection - Mobile-friendly at the top -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <label for="subject" class="form-label">Select Subject:</label>
                <select class="form-select" id="subject">
                    <option value="Mathematics">Mathematics</option>
                    <option value="Physics">Physics</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Biology">Biology</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="analysis-mode" class="form-label">Analysis Mode:</label>
                <select class="form-select" id="analysis-mode">
                    <option value="answer-feedback">Get Answer Feedback</option>
                    <option value="explanation-only">Get Explanation Only</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Simplified Two-Step Process -->
<div class="row">
    <div class="col-12">
        <!-- Step Indicator -->
        <div class="card mb-3">
            <div class="card-body p-0">
                <ul class="nav nav-pills nav-justified" id="captureSteps">
                    <li class="nav-item">
                        <button class="nav-link active" id="capture-tab" data-bs-toggle="pill" data-bs-target="#capture-step" type="button">
                            <i class="fas fa-camera me-1"></i> Capture Image
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="feedback-tab" data-bs-toggle="pill" data-bs-target="#feedback-step" type="button" disabled>
                            <i class="fas fa-comments me-1"></i> View Feedback
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Step Content -->
        <div class="tab-content">
            <!-- Step 1: Capture Image -->
            <div class="tab-pane fade show active" id="capture-step">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0" id="capture-header">
                            <i class="fas fa-camera me-2"></i> <span id="capture-title">Capture Your Work</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Capture Instructions -->
                        <div class="p-3 bg-light border-bottom" id="capture-instructions">
                            <i class="fas fa-info-circle me-2 text-primary"></i>
                            <span id="instruction-text">Take a photo that shows both the question and your answer on the same page.</span>
                        </div>
                        
                        <!-- Video stream -->
                        <div id="camera-container" class="mb-0 text-center">
                            <video id="video" width="100%" autoplay playsinline 
                                style="background-color: #000; display: block; max-height: 70vh;"></video>
                            <div class="p-3 text-center">
                                <button id="capture-btn" class="btn btn-lg btn-primary w-100">
                                    <i class="fas fa-camera me-1"></i> Capture Image
                                </button>
                            </div>
                        </div>
                        
                        <!-- Captured image display -->
                        <div id="capture-result" class="p-3" style="display: none;">
                            <h6 class="mb-2" id="result-label">Captured Image:</h6>
                            <div class="mb-3 text-center">
                                <canvas id="canvas" width="640" height="480" class="img-fluid border rounded"></canvas>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                <button id="retake-btn" class="btn btn-outline-secondary flex-grow-1">
                                    <i class="fas fa-undo me-1"></i> Retake
                                </button>
                                <button id="analyze-btn" class="btn btn-success flex-grow-1">
                                    <i class="fas fa-lightbulb me-1"></i> <span id="analyze-btn-text">Analyze</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Feedback (will be shown when analysis is complete) -->
            <div class="tab-pane fade" id="feedback-step">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-robot me-2"></i> AI Feedback
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Loading state -->
                        <div id="feedback-loading" style="display: none;">
                            <div class="d-flex justify-content-center my-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <p class="text-center text-muted">Analyzing your answer... This may take a few moments.</p>
                        </div>
                        
                        <!-- Result state -->
                        <div id="feedback-result" style="display: none;">
                            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <span class="badge bg-primary px-3 py-2" id="feedback-subject">Subject</span>
                                    <span class="badge bg-success px-3 py-2 ms-2" id="feedback-score">Score</span>
                                </div>
                                <div>
                                    <small class="text-muted fst-italic" id="feedback-timestamp">Timestamp</small>
                                </div>
                            </div>
                            
                            <!-- Tabbed feedback results -->
                            <ul class="nav nav-tabs mb-3" id="feedbackTabs">
                                <li class="nav-item">
                                    <button class="nav-link active" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback-content-tab">Feedback</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" id="explanation-tab" data-bs-toggle="tab" data-bs-target="#explanation-content-tab">Full Explanation</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" id="tips-tab" data-bs-toggle="tab" data-bs-target="#tips-content-tab">Improvement Tips</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="feedback-content-tab">
                                    <div id="feedback-content" class="mb-3 feedback-content">
                                        <!-- Feedback content will be loaded here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="explanation-content-tab">
                                    <div id="explanation-content" class="mb-3 explanation-content">
                                        <!-- Explanation content will be loaded here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="tips-content-tab">
                                    <div id="tips-content" class="mb-3 tips-content">
                                        <!-- Tips content will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Start over button -->
                            <div class="text-center mt-4">
                                <button id="start-over-btn" class="btn btn-primary">
                                    <i class="fas fa-redo me-1"></i> Start Over
                                </button>
                            </div>
                        </div>
                        
                        <!-- Empty state -->
                        <div id="feedback-placeholder">
                            <div class="text-center my-5 py-5">
                                <i class="fas fa-lightbulb text-muted" style="font-size: 3rem;"></i>
                                <p class="mt-3 text-muted">Capture your question and answer to get personalized feedback and tips</p>
                            </div>
                        </div>
                        
                        <!-- Error state with improved styling -->
                        <div id="feedback-error" class="alert alert-danger" style="display: none;">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-triangle me-2 fs-4"></i>
                                <strong>There was a problem</strong>
                            </div>
                            <p id="error-message" class="mb-0">Error message will appear here</p>
                            <!-- Retry button will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Step elements
        const captureTab = document.getElementById('capture-tab');
        const feedbackTab = document.getElementById('feedback-tab');
        const analysisMode = document.getElementById('analysis-mode');
        
        // Capture elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analyzeBtnText = document.getElementById('analyze-btn-text');
        const cameraContainer = document.getElementById('camera-container');
        const captureResult = document.getElementById('capture-result');
        const captureInstructions = document.getElementById('capture-instructions');
        const instructionText = document.getElementById('instruction-text');
        const captureTitle = document.getElementById('capture-title');
        const resultLabel = document.getElementById('result-label');
        
        // Subject selection
        const subjectSelect = document.getElementById('subject');
        
        // Subject selection
        const subjectSelect = document.getElementById('subject');
        
        // API status elements
        const apiStatusAlert = document.getElementById('api-status-alert');
        const apiStatusMessage = document.getElementById('api-status-message');
        
        // Feedback elements
        const feedbackLoading = document.getElementById('feedback-loading');
        const feedbackResult = document.getElementById('feedback-result');
        const feedbackPlaceholder = document.getElementById('feedback-placeholder');
        const feedbackError = document.getElementById('feedback-error');
        const feedbackContent = document.getElementById('feedback-content');
        const explanationContent = document.getElementById('explanation-content');
        const tipsContent = document.getElementById('tips-content');
        const feedbackSubject = document.getElementById('feedback-subject');
        const feedbackScore = document.getElementById('feedback-score');
        const feedbackTimestamp = document.getElementById('feedback-timestamp');
        const errorMessage = document.getElementById('error-message');
        const startOverBtn = document.getElementById('start-over-btn');
        
        // Camera stream
        let stream;
        
        // Global variable to store captured image
        let capturedImageData;
        
        // Function to update UI based on selected mode
        function updateModeUI() {
            const mode = analysisMode.value;
            
            if (mode === 'explanation-only') {
                // Update instructions for question-only mode
                instructionText.textContent = 'Take a clear photo of just the question to get an explanation.';
                captureTitle.textContent = 'Capture Question';
                resultLabel.textContent = 'Question Image:';
                analyzeBtnText.textContent = 'Get Explanation';
                // Hide the score badge in explanation-only mode
                if (feedbackScore) {
                    feedbackScore.style.display = 'none';
                }
            } else {
                // Update instructions for answer feedback mode
                instructionText.textContent = 'Take a photo that shows both the question and your answer on the same page.';
                captureTitle.textContent = 'Capture Your Work';
                resultLabel.textContent = 'Captured Image:';
                analyzeBtnText.textContent = 'Get Feedback';
                // Show the score badge in answer feedback mode
                if (feedbackScore) {
                    feedbackScore.style.display = 'inline-block';
                }
            }
        }
        
        // Function to start the camera
        async function startCamera() {
            try {
                // Try to access the camera
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Use the back camera on mobile devices if available
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // Show the video stream
                video.srcObject = stream;
                
                // Show camera UI
                cameraContainer.style.display = 'block';
                captureBtn.disabled = false;
            } catch (err) {
                console.error('Error accessing camera:', err);
                cameraContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Unable to access camera: ${err.message}
                    </div>
                    <p class="mt-3">Make sure your browser has permission to access the camera and try again.</p>
                `;
                captureBtn.disabled = true;
            }
        }
        
        // Function to stop camera stream
        function stopCameraStream() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }
        
        // Function to check OpenAI API availability
        function checkOpenAIStatus() {
            // Show the API status alert
            apiStatusAlert.style.display = 'block';
            apiStatusAlert.className = 'alert alert-warning mb-4';
            apiStatusMessage.textContent = 'Checking OpenAI API connection...';
            
            // Make a request to check the API status
            fetch('/api/test-openai')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // API is available
                        apiStatusAlert.className = 'alert alert-success mb-4';
                        apiStatusMessage.textContent = 'OpenAI API connection successful. You can analyze images.';
                        
                        // Hide the alert after 3 seconds
                        setTimeout(() => {
                            apiStatusAlert.style.display = 'none';
                        }, 3000);
                        
                        // Enable the analyze button
                        analyzeBtn.disabled = false;
                    } else {
                        // API is not available
                        apiStatusAlert.className = 'alert alert-danger mb-4';
                        apiStatusMessage.textContent = 'OpenAI API connection failed. Image analysis will not work.';
                        
                        // Add a retry button
                        const retryButton = document.createElement('button');
                        retryButton.className = 'btn btn-sm btn-outline-danger mt-2';
                        retryButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Retry Connection';
                        retryButton.onclick = function() {
                            // Remove the button first
                            if (apiStatusAlert.querySelector('button')) {
                                apiStatusAlert.querySelector('button').remove();
                            }
                            // Check API again
                            checkOpenAIStatus();
                        };
                        
                        // Add the button to the alert if it doesn't already have one
                        if (!apiStatusAlert.querySelector('button')) {
                            apiStatusAlert.appendChild(retryButton);
                        }
                        
                        // Disable the analyze button
                        analyzeBtn.disabled = true;
                    }
                })
                .catch(error => {
                    // Error checking API
                    apiStatusAlert.className = 'alert alert-danger mb-4';
                    apiStatusMessage.textContent = 'Error checking OpenAI API status. Image analysis may not work.';
                    console.error('API Status Error:', error);
                    
                    // Add a retry button
                    const retryButton = document.createElement('button');
                    retryButton.className = 'btn btn-sm btn-outline-danger mt-2';
                    retryButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Retry Connection';
                    retryButton.onclick = function() {
                        // Remove the button first
                        if (apiStatusAlert.querySelector('button')) {
                            apiStatusAlert.querySelector('button').remove();
                        }
                        // Check API again
                        checkOpenAIStatus();
                    };
                    
                    // Add the button to the alert if it doesn't already have one
                    if (!apiStatusAlert.querySelector('button')) {
                        apiStatusAlert.appendChild(retryButton);
                    }
                });
        }
        
        // Start the camera when the page loads
        startCamera();
        
        // Initialize UI based on selected mode
        updateModeUI();
        
        // Check OpenAI API status when page loads
        checkOpenAIStatus();
        
        // Handle mode change
        analysisMode.addEventListener('change', function() {
            updateModeUI();
        });
        
        // Capture image
        captureBtn.addEventListener('click', function() {
            // Get the canvas context
            const context = canvas.getContext('2d');
            
            // Set canvas dimensions to match video dimensions
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw the current video frame on the canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Save the image data
            capturedImageData = canvas.toDataURL('image/jpeg', 0.7);
            
            // Show the captured image and hide the camera
            cameraContainer.style.display = 'none';
            captureResult.style.display = 'block';
        });
        
        // Retake photo
        retakeBtn.addEventListener('click', function() {
            // Show camera again
            cameraContainer.style.display = 'block';
            captureResult.style.display = 'none';
        });
        
        // Analyze button (after capturing image)
        analyzeBtn.addEventListener('click', function() {
            // Disable the analyze button during processing
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Processing...';
            
            // Stop the camera
            stopCameraStream();
            
            // Enable and show the feedback step
            feedbackTab.disabled = false;
            feedbackTab.click();
            
            // Show loading
            feedbackLoading.style.display = 'block';
            feedbackResult.style.display = 'none';
            feedbackPlaceholder.style.display = 'none';
            feedbackError.style.display = 'none';
            
            // Get the subject and mode
            const subject = subjectSelect.value;
            const mode = analysisMode.value;
            
            if (mode === 'explanation-only') {
                // Send to server for question-only analysis
                fetch('/api/analyze-captured-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_data: capturedImageData,
                        subject: subject,
                        mode: 'question-only'
                    })
                })
                .then(response => response.json())
                .then(data => handleExplanationResponse(data))
                .catch(error => handleAnalysisError(error));
            } else {
                // Send to server for answer analysis
                fetch('/api/analyze-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_image: capturedImageData, // In this case, the single image contains both
                        answer_image: capturedImageData,   // We send the same image twice
                        subject: subject
                    })
                })
                .then(response => response.json())
                .then(data => handleFeedbackResponse(data))
                .catch(error => handleAnalysisError(error));
            }
        });
        
        // Start over button
        startOverBtn.addEventListener('click', function() {
            // Clear previous capture
            capturedImageData = null;
            
            // Reset UI
            feedbackResult.style.display = 'none';
            feedbackPlaceholder.style.display = 'block';
            
            // Reset the analyze button
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = `<i class="fas fa-lightbulb me-1"></i> <span id="analyze-btn-text">${analysisMode.value === 'explanation-only' ? 'Get Explanation' : 'Get Feedback'}</span>`;
            
            // Go back to capture step
            captureTab.click();
            
            // Start the camera again
            startCamera();
        });
        
        // Function to handle explanation-only response
        function handleExplanationResponse(data) {
            // Hide loading
            feedbackLoading.style.display = 'none';
            
            // Reset the analyze button
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-lightbulb me-1"></i> <span id="analyze-btn-text">Get Explanation</span>';
            
            if (data.success) {
                // Show the explanation
                feedbackResult.style.display = 'block';
                explanationContent.innerHTML = data.explanation;
                feedbackContent.innerHTML = '<div class="alert alert-info">Explanation-only mode: see the full explanation tab for details.</div>';
                tipsContent.innerHTML = '<div class="alert alert-success">Review the full explanation to understand this question thoroughly.</div>';
                
                feedbackSubject.textContent = data.subject;
                feedbackTimestamp.textContent = data.timestamp;
                
                // Hide the score in explanation-only mode
                feedbackScore.style.display = 'none';
                
                // Trigger MathJax typesetting for all content tabs
                if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                    MathJax.typesetPromise([explanationContent, feedbackContent, tipsContent])
                        .then(() => console.log('MathJax typesetting complete'))
                        .catch(err => console.error('MathJax typesetting failed:', err));
                }
            } else {
                // Show error
                feedbackError.style.display = 'block';
                errorMessage.textContent = data.message || 'An error occurred';
            }
        }
        
        // Function to handle feedback response (both question and answer)
        function handleFeedbackResponse(data) {
            // Hide loading
            feedbackLoading.style.display = 'none';
            
            // Reset the analyze button
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-lightbulb me-1"></i> <span id="analyze-btn-text">Get Feedback</span>';
            
            if (data.success) {
                // Show the results
                feedbackResult.style.display = 'block';
                
                // Populate the different tabs
                feedbackContent.innerHTML = data.feedback || 'No feedback available';
                explanationContent.innerHTML = data.explanation || 'No explanation available';
                tipsContent.innerHTML = data.tips || 'No tips available';
                
                // Show metadata
                feedbackSubject.textContent = data.subject;
                feedbackScore.textContent = data.score || 'N/A';
                feedbackScore.style.display = 'inline-block';
                feedbackTimestamp.textContent = data.timestamp;
                
                // Trigger MathJax typesetting for all content tabs
                if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                    MathJax.typesetPromise([feedbackContent, explanationContent, tipsContent])
                        .then(() => console.log('MathJax typesetting complete'))
                        .catch(err => console.error('MathJax typesetting failed:', err));
                }
            } else {
                // Show error
                feedbackError.style.display = 'block';
                errorMessage.textContent = data.message || 'An error occurred';
            }
        }
        
        // Function to handle analysis errors
        function handleAnalysisError(error) {
            // Hide loading
            feedbackLoading.style.display = 'none';
            
            // Reset the analyze button
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = `<i class="fas fa-lightbulb me-1"></i> <span id="analyze-btn-text">${analysisMode.value === 'explanation-only' ? 'Get Explanation' : 'Get Feedback'}</span>`;
            
            console.error('API Error:', error);
            
            // Show error
            feedbackError.style.display = 'block';
            
            // Provide helpful error messages
            let errorMsg;
            
            if (error.message && error.message.includes('pattern')) {
                errorMsg = 'Image format error: There was an issue with the captured image. Please try again with a clearer picture.';
            } else if (error.message && error.message.includes('Failed to fetch')) {
                errorMsg = 'Connection error: Please check your internet connection and try again.';
            } else {
                errorMsg = 'Error: ' + (error.message || 'Something went wrong. Please try again.');
            }
            
            errorMessage.textContent = errorMsg;
            
            // Add retry button to error message
            const retryButton = document.createElement('button');
            retryButton.className = 'btn btn-outline-primary mt-3';
            retryButton.innerHTML = '<i class="fas fa-redo me-1"></i> Try Again';
            retryButton.onclick = function() {
                // Remove button
                if (errorMessage.nextElementSibling) {
                    errorMessage.parentNode.removeChild(errorMessage.nextElementSibling);
                }
                
                // Hide error and go back to capture step
                feedbackError.style.display = 'none';
                captureTab.click();
                
                // Start the camera again
                startCamera();
            };
            
            if (!errorMessage.nextElementSibling || !errorMessage.nextElementSibling.classList.contains('btn')) {
                errorMessage.parentNode.appendChild(retryButton);
            }
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            // Stop camera stream
            stopCameraStream();
        });
    });
</script>
{% endblock %}
