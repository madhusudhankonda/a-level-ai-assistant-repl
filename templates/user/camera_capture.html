{% extends "base.html" %}

{% block title %}Student Answer Feedback - A-Level AI Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h1 class="mb-4">Student Answer Feedback</h1>
        <p class="lead">Capture a question and your answer to get instant feedback</p>
        <div class="mb-3">
            <a href="{{ url_for('user.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Papers
            </a>
        </div>
        
        <!-- API Status Alert (hidden by default) -->
        <div id="api-status-alert" class="alert alert-warning mb-4" style="display: none;">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-circle me-2 fs-4"></i>
                <div>
                    <strong>API Status Check</strong>
                    <p id="api-status-message" class="mb-0">Checking OpenAI API connection...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Subject Selection and Mode Selection - Mobile-friendly at the top -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <label for="subject" class="form-label">Select Subject:</label>
                <select class="form-select" id="subject">
                    <option value="Mathematics">Mathematics</option>
                    <option value="Physics">Physics</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Biology">Biology</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="capture-mode" class="form-label">Capture Mode:</label>
                <select class="form-select" id="capture-mode">
                    <option value="question-answer">Question & My Answer</option>
                    <option value="question-only">Question Only (Get Explanation)</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Capture Process Steps -->
<div class="row">
    <div class="col-12">
        <!-- Step Indicator -->
        <div class="card mb-3">
            <div class="card-body p-0">
                <ul class="nav nav-pills nav-justified" id="captureSteps">
                    <li class="nav-item">
                        <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button">
                            <span class="d-none d-sm-inline">1. Capture Question</span>
                            <span class="d-inline d-sm-none">1. Question</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" disabled>
                            <span class="d-none d-sm-inline">2. Capture Answer</span>
                            <span class="d-inline d-sm-none">2. Answer</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="step3-tab" data-bs-toggle="pill" data-bs-target="#step3" type="button" disabled>
                            <span class="d-none d-sm-inline">3. Get Feedback</span>
                            <span class="d-inline d-sm-none">3. Feedback</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Step Content -->
        <div class="tab-content">
            <!-- Step 1: Capture Question -->
            <div class="tab-pane fade show active" id="step1">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-camera me-2"></i> Capture Question Image
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Video stream for question -->
                        <div id="question-camera-container" class="mb-0 text-center">
                            <video id="video" width="100%" autoplay playsinline 
                                style="background-color: #000; display: block; max-height: 70vh;"></video>
                            <div class="p-3 text-center">
                                <button id="capture-question-btn" class="btn btn-lg btn-primary w-100">
                                    <i class="fas fa-camera me-1"></i> Capture Question
                                </button>
                            </div>
                        </div>
                        
                        <!-- Captured question image display -->
                        <div id="question-result" class="p-3" style="display: none;">
                            <h6 class="mb-2">Question Image:</h6>
                            <div class="mb-3 text-center">
                                <canvas id="question-canvas" width="640" height="480" class="img-fluid border rounded"></canvas>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                <button id="retake-question-btn" class="btn btn-outline-secondary flex-grow-1">
                                    <i class="fas fa-undo me-1"></i> Retake
                                </button>
                                <button id="next-to-answer-btn" class="btn btn-success flex-grow-1">
                                    <i class="fas fa-arrow-right me-1"></i> Next <span class="d-none d-sm-inline">Step</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Capture Answer (will be shown when the Question is captured) -->
            <div class="tab-pane fade" id="step2">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-pen me-2"></i> Capture Your Answer
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <!-- Video stream for answer -->
                        <div id="answer-camera-container" class="mb-0 text-center">
                            <video id="answer-video" width="100%" autoplay playsinline 
                                style="background-color: #000; display: block; max-height: 70vh;"></video>
                            <div class="p-3 text-center">
                                <button id="capture-answer-btn" class="btn btn-lg btn-info text-white w-100">
                                    <i class="fas fa-camera me-1"></i> Capture Answer
                                </button>
                            </div>
                        </div>
                        
                        <!-- Captured answer image display -->
                        <div id="answer-result" class="p-3" style="display: none;">
                            <h6 class="mb-2">Your Answer:</h6>
                            <div class="mb-3 text-center">
                                <canvas id="answer-canvas" width="640" height="480" class="img-fluid border rounded"></canvas>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                <button id="retake-answer-btn" class="btn btn-outline-secondary flex-grow-1">
                                    <i class="fas fa-undo me-1"></i> Retake
                                </button>
                                <button id="analyze-both-btn" class="btn btn-success flex-grow-1">
                                    <i class="fas fa-lightbulb me-1"></i> Get Feedback
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Feedback (will be shown when analysis is complete) -->
            <div class="tab-pane fade" id="step3">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-robot me-2"></i> AI Feedback
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Loading state -->
                        <div id="feedback-loading" style="display: none;">
                            <div class="d-flex justify-content-center my-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <p class="text-center text-muted">Analyzing your answer... This may take a few moments.</p>
                        </div>
                        
                        <!-- Result state -->
                        <div id="feedback-result" style="display: none;">
                            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <span class="badge bg-primary px-3 py-2" id="feedback-subject">Subject</span>
                                    <span class="badge bg-success px-3 py-2 ms-2" id="feedback-score">Score</span>
                                </div>
                                <div>
                                    <small class="text-muted fst-italic" id="feedback-timestamp">Timestamp</small>
                                </div>
                            </div>
                            
                            <!-- Tabbed feedback results -->
                            <ul class="nav nav-tabs mb-3" id="feedbackTabs">
                                <li class="nav-item">
                                    <button class="nav-link active" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback-content-tab">Feedback</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" id="explanation-tab" data-bs-toggle="tab" data-bs-target="#explanation-content-tab">Full Explanation</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" id="tips-tab" data-bs-toggle="tab" data-bs-target="#tips-content-tab">Improvement Tips</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="feedback-content-tab">
                                    <div id="feedback-content" class="mb-3 feedback-content">
                                        <!-- Feedback content will be loaded here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="explanation-content-tab">
                                    <div id="explanation-content" class="mb-3 explanation-content">
                                        <!-- Explanation content will be loaded here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="tips-content-tab">
                                    <div id="tips-content" class="mb-3 tips-content">
                                        <!-- Tips content will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Start over button -->
                            <div class="text-center mt-4">
                                <button id="start-over-btn" class="btn btn-primary">
                                    <i class="fas fa-redo me-1"></i> Start Over
                                </button>
                            </div>
                        </div>
                        
                        <!-- Empty state -->
                        <div id="feedback-placeholder">
                            <div class="text-center my-5 py-5">
                                <i class="fas fa-lightbulb text-muted" style="font-size: 3rem;"></i>
                                <p class="mt-3 text-muted">Capture your question and answer to get personalized feedback and tips</p>
                            </div>
                        </div>
                        
                        <!-- Error state with improved styling -->
                        <div id="feedback-error" class="alert alert-danger" style="display: none;">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-triangle me-2 fs-4"></i>
                                <strong>There was a problem</strong>
                            </div>
                            <p id="error-message" class="mb-0">Error message will appear here</p>
                            <!-- Retry button will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Step elements
        const step1Tab = document.getElementById('step1-tab');
        const step2Tab = document.getElementById('step2-tab');
        const step3Tab = document.getElementById('step3-tab');
        const captureMode = document.getElementById('capture-mode');
        
        // Question capture elements
        const video = document.getElementById('video');
        const questionCanvas = document.getElementById('question-canvas');
        const captureQuestionBtn = document.getElementById('capture-question-btn');
        const retakeQuestionBtn = document.getElementById('retake-question-btn');
        const nextToAnswerBtn = document.getElementById('next-to-answer-btn');
        const questionCameraContainer = document.getElementById('question-camera-container');
        const questionResult = document.getElementById('question-result');
        
        // Answer capture elements
        const answerVideo = document.getElementById('answer-video');
        const answerCanvas = document.getElementById('answer-canvas');
        const captureAnswerBtn = document.getElementById('capture-answer-btn');
        const retakeAnswerBtn = document.getElementById('retake-answer-btn');
        const analyzeBothBtn = document.getElementById('analyze-both-btn');
        const answerCameraContainer = document.getElementById('answer-camera-container');
        const answerResult = document.getElementById('answer-result');
        
        // Subject selection
        const subjectSelect = document.getElementById('subject');
        
        // API status elements
        const apiStatusAlert = document.getElementById('api-status-alert');
        const apiStatusMessage = document.getElementById('api-status-message');
        
        // Feedback elements
        const feedbackLoading = document.getElementById('feedback-loading');
        const feedbackResult = document.getElementById('feedback-result');
        const feedbackPlaceholder = document.getElementById('feedback-placeholder');
        const feedbackError = document.getElementById('feedback-error');
        const feedbackContent = document.getElementById('feedback-content');
        const explanationContent = document.getElementById('explanation-content');
        const tipsContent = document.getElementById('tips-content');
        const feedbackSubject = document.getElementById('feedback-subject');
        const feedbackScore = document.getElementById('feedback-score');
        const feedbackTimestamp = document.getElementById('feedback-timestamp');
        const errorMessage = document.getElementById('error-message');
        const startOverBtn = document.getElementById('start-over-btn');
        
        // Camera streams
        let questionStream;
        let answerStream;
        
        // Global variables to store captured images
        let questionImageData;
        let answerImageData;
        
        // Function to start the question camera
        async function startQuestionCamera() {
            try {
                // Try to access the camera for question capture
                questionStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Use the back camera on mobile devices if available
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // Show the video stream
                video.srcObject = questionStream;
                
                // Show camera UI
                questionCameraContainer.style.display = 'block';
                captureQuestionBtn.disabled = false;
            } catch (err) {
                console.error('Error accessing camera for question:', err);
                questionCameraContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Unable to access camera: ${err.message}
                    </div>
                    <p class="mt-3">Make sure your browser has permission to access the camera and try again.</p>
                `;
                captureQuestionBtn.disabled = true;
            }
        }
        
        // Function to start the answer camera
        async function startAnswerCamera() {
            try {
                // Try to access the camera for answer capture
                answerStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Use the back camera on mobile devices if available
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // Show the video stream
                answerVideo.srcObject = answerStream;
                
                // Show camera UI
                answerCameraContainer.style.display = 'block';
                captureAnswerBtn.disabled = false;
            } catch (err) {
                console.error('Error accessing camera for answer:', err);
                answerCameraContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Unable to access camera: ${err.message}
                    </div>
                    <p class="mt-3">Make sure your browser has permission to access the camera and try again.</p>
                `;
                captureAnswerBtn.disabled = true;
            }
        }
        
        // Function to stop camera stream
        function stopCameraStream(stream) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }
        
        // Function to check OpenAI API availability
        function checkOpenAIStatus() {
            // Show the API status alert
            apiStatusAlert.style.display = 'block';
            apiStatusAlert.className = 'alert alert-warning mb-4';
            apiStatusMessage.textContent = 'Checking OpenAI API connection...';
            
            // Make a request to check the API status
            fetch('/api/test-openai')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // API is available
                        apiStatusAlert.className = 'alert alert-success mb-4';
                        apiStatusMessage.textContent = 'OpenAI API connection successful. You can analyze images.';
                        
                        // Hide the alert after 3 seconds
                        setTimeout(() => {
                            apiStatusAlert.style.display = 'none';
                        }, 3000);
                        
                        // Enable the analyze button
                        analyzeBtn.disabled = false;
                    } else {
                        // API is not available
                        apiStatusAlert.className = 'alert alert-danger mb-4';
                        apiStatusMessage.textContent = 'OpenAI API connection failed. Image analysis will not work.';
                        
                        // Add a retry button
                        const retryButton = document.createElement('button');
                        retryButton.className = 'btn btn-sm btn-outline-danger mt-2';
                        retryButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Retry Connection';
                        retryButton.onclick = function() {
                            // Remove the button first
                            if (apiStatusAlert.querySelector('button')) {
                                apiStatusAlert.querySelector('button').remove();
                            }
                            // Check API again
                            checkOpenAIStatus();
                        };
                        
                        // Add the button to the alert if it doesn't already have one
                        if (!apiStatusAlert.querySelector('button')) {
                            apiStatusAlert.appendChild(retryButton);
                        }
                        
                        // Disable the analyze button
                        analyzeBtn.disabled = true;
                    }
                })
                .catch(error => {
                    // Error checking API
                    apiStatusAlert.className = 'alert alert-danger mb-4';
                    apiStatusMessage.textContent = 'Error checking OpenAI API status. Image analysis may not work.';
                    console.error('API Status Error:', error);
                    
                    // Add a retry button
                    const retryButton = document.createElement('button');
                    retryButton.className = 'btn btn-sm btn-outline-danger mt-2';
                    retryButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Retry Connection';
                    retryButton.onclick = function() {
                        // Remove the button first
                        if (apiStatusAlert.querySelector('button')) {
                            apiStatusAlert.querySelector('button').remove();
                        }
                        // Check API again
                        checkOpenAIStatus();
                    };
                    
                    // Add the button to the alert if it doesn't already have one
                    if (!apiStatusAlert.querySelector('button')) {
                        apiStatusAlert.appendChild(retryButton);
                    }
                });
        }
        
        // Start the question camera when the page loads
        startQuestionCamera();
        
        // Check OpenAI API status when page loads
        checkOpenAIStatus();
        
        // Handle mode change
        captureMode.addEventListener('change', function() {
            const mode = captureMode.value;
            
            // Update UI based on selected mode
            if (mode === 'question-only') {
                // Disable the answer step
                step2Tab.style.display = 'none';
                // Change the text of the Next button
                nextToAnswerBtn.innerHTML = '<i class="fas fa-lightbulb me-1"></i> Analyze Question';
            } else {
                // Enable the answer step
                step2Tab.style.display = 'block';
                // Change the text back
                nextToAnswerBtn.innerHTML = '<i class="fas fa-arrow-right me-1"></i> Next <span class="d-none d-sm-inline">Step</span>';
            }
        });
        
        // Capture question image
        captureQuestionBtn.addEventListener('click', function() {
            // Get the canvas context
            const context = questionCanvas.getContext('2d');
            
            // Set canvas dimensions to match video dimensions
            questionCanvas.width = video.videoWidth;
            questionCanvas.height = video.videoHeight;
            
            // Draw the current video frame on the canvas
            context.drawImage(video, 0, 0, questionCanvas.width, questionCanvas.height);
            
            // Save the question image data
            questionImageData = questionCanvas.toDataURL('image/jpeg', 0.7);
            
            // Show the captured image and hide the camera
            questionCameraContainer.style.display = 'none';
            questionResult.style.display = 'block';
        });
        
        // Retake question photo
        retakeQuestionBtn.addEventListener('click', function() {
            // Show camera again
            questionCameraContainer.style.display = 'block';
            questionResult.style.display = 'none';
        });
        
        // Next step button (after capturing question)
        nextToAnswerBtn.addEventListener('click', function() {
            const mode = captureMode.value;
            
            if (mode === 'question-only') {
                // If in question-only mode, skip to analysis
                analyzeQuestionOnly();
            } else {
                // Stop the question camera
                stopCameraStream(questionStream);
                
                // Enable and show the answer step
                step2Tab.disabled = false;
                step2Tab.click();
                
                // Start the answer camera
                startAnswerCamera();
            }
        });
        
        // Capture answer image
        captureAnswerBtn.addEventListener('click', function() {
            // Get the canvas context
            const context = answerCanvas.getContext('2d');
            
            // Set canvas dimensions to match video dimensions
            answerCanvas.width = answerVideo.videoWidth;
            answerCanvas.height = answerVideo.videoHeight;
            
            // Draw the current video frame on the canvas
            context.drawImage(answerVideo, 0, 0, answerCanvas.width, answerCanvas.height);
            
            // Save the answer image data
            answerImageData = answerCanvas.toDataURL('image/jpeg', 0.7);
            
            // Show the captured image and hide the camera
            answerCameraContainer.style.display = 'none';
            answerResult.style.display = 'block';
        });
        
        // Retake answer photo
        retakeAnswerBtn.addEventListener('click', function() {
            // Show camera again
            answerCameraContainer.style.display = 'block';
            answerResult.style.display = 'none';
        });
        
        // Analyze button (after capturing both question and answer)
        analyzeBothBtn.addEventListener('click', function() {
            // Stop the answer camera
            stopCameraStream(answerStream);
            
            // Enable and show the feedback step
            step3Tab.disabled = false;
            step3Tab.click();
            
            // Analyze both images
            analyzeQuestionAndAnswer();
        });
        
        // Start over button
        startOverBtn.addEventListener('click', function() {
            // Clear previous captures
            questionImageData = null;
            answerImageData = null;
            
            // Reset UI
            feedbackResult.style.display = 'none';
            feedbackPlaceholder.style.display = 'block';
            
            // Go back to step 1
            step1Tab.click();
            
            // Start the question camera again
            startQuestionCamera();
        });
        
        // Function to analyze question-only mode
        function analyzeQuestionOnly() {
            // Stop the camera
            stopCameraStream(questionStream);
            
            // Enable and show the feedback step
            step3Tab.disabled = false;
            step3Tab.click();
            
            // Show loading
            feedbackLoading.style.display = 'block';
            feedbackResult.style.display = 'none';
            feedbackPlaceholder.style.display = 'none';
            feedbackError.style.display = 'none';
            
            // Get the subject
            const subject = subjectSelect.value;
            
            // Send to server for analysis
            fetch('/api/analyze-captured-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image_data: questionImageData,
                    subject: subject,
                    mode: 'question-only'
                })
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading
                feedbackLoading.style.display = 'none';
                
                if (data.success) {
                    // Show the explanation
                    feedbackResult.style.display = 'block';
                    explanationContent.innerHTML = data.explanation;
                    feedbackContent.innerHTML = '<div class="alert alert-info">Question-only mode: see the full explanation tab for details.</div>';
                    tipsContent.innerHTML = '<div class="alert alert-success">Review the full explanation to understand this question thoroughly.</div>';
                    
                    feedbackSubject.textContent = data.subject;
                    feedbackTimestamp.textContent = data.timestamp;
                    
                    // Hide the score in question-only mode
                    feedbackScore.style.display = 'none';
                    
                    // Trigger MathJax typesetting for all content tabs
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        MathJax.typesetPromise([explanationContent, feedbackContent, tipsContent])
                            .then(() => console.log('MathJax typesetting complete'))
                            .catch(err => console.error('MathJax typesetting failed:', err));
                    }
                } else {
                    // Show error
                    feedbackError.style.display = 'block';
                    errorMessage.textContent = data.message || 'An error occurred';
                }
            })
            .catch(error => {
                // Hide loading
                feedbackLoading.style.display = 'none';
                
                console.error('API Error:', error);
                
                // Show error
                feedbackError.style.display = 'block';
                
                // Provide helpful error messages
                let errorMsg;
                
                if (error.message && error.message.includes('pattern')) {
                    errorMsg = 'Image format error: There was an issue with the captured image. Please try again with a clearer picture.';
                } else if (error.message && error.message.includes('Failed to fetch')) {
                    errorMsg = 'Connection error: Please check your internet connection and try again.';
                } else {
                    errorMsg = 'Error: ' + (error.message || 'Something went wrong. Please try again.');
                }
                
                errorMessage.textContent = errorMsg;
                
                // Add retry button to error message
                const retryButton = document.createElement('button');
                retryButton.className = 'btn btn-outline-primary mt-3';
                retryButton.innerHTML = '<i class="fas fa-redo me-1"></i> Try Again';
                retryButton.onclick = function() {
                    // Remove button
                    if (errorMessage.nextElementSibling) {
                        errorMessage.parentNode.removeChild(errorMessage.nextElementSibling);
                    }
                    
                    // Hide error and go back to step 1
                    feedbackError.style.display = 'none';
                    step1Tab.click();
                    
                    // Start the camera again
                    startQuestionCamera();
                };
                
                if (!errorMessage.nextElementSibling || !errorMessage.nextElementSibling.classList.contains('btn')) {
                    errorMessage.parentNode.appendChild(retryButton);
                }
            });
        }
        
        // Function to analyze both question and answer
        function analyzeQuestionAndAnswer() {
            // Show loading
            feedbackLoading.style.display = 'block';
            feedbackResult.style.display = 'none';
            feedbackPlaceholder.style.display = 'none';
            feedbackError.style.display = 'none';
            
            // Get the subject
            const subject = subjectSelect.value;
            
            // Send to server for analysis
            fetch('/api/analyze-answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question_image: questionImageData,
                    answer_image: answerImageData,
                    subject: subject
                })
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading
                feedbackLoading.style.display = 'none';
                
                if (data.success) {
                    // Show the results
                    feedbackResult.style.display = 'block';
                    
                    // Populate the different tabs
                    feedbackContent.innerHTML = data.feedback || 'No feedback available';
                    explanationContent.innerHTML = data.explanation || 'No explanation available';
                    tipsContent.innerHTML = data.tips || 'No tips available';
                    
                    // Show metadata
                    feedbackSubject.textContent = data.subject;
                    feedbackScore.textContent = data.score || 'N/A';
                    feedbackScore.style.display = 'inline-block';
                    feedbackTimestamp.textContent = data.timestamp;
                    
                    // Trigger MathJax typesetting for all content tabs
                    if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                        MathJax.typesetPromise([feedbackContent, explanationContent, tipsContent])
                            .then(() => console.log('MathJax typesetting complete'))
                            .catch(err => console.error('MathJax typesetting failed:', err));
                    }
                } else {
                    // Show error
                    feedbackError.style.display = 'block';
                    errorMessage.textContent = data.message || 'An error occurred';
                }
            })
            .catch(error => {
                // Hide loading
                feedbackLoading.style.display = 'none';
                
                console.error('API Error:', error);
                
                // Show error
                feedbackError.style.display = 'block';
                
                // Provide helpful error messages
                let errorMsg;
                
                if (error.message && error.message.includes('pattern')) {
                    errorMsg = 'Image format error: There was an issue with the captured images. Please try again with clearer pictures.';
                } else if (error.message && error.message.includes('Failed to fetch')) {
                    errorMsg = 'Connection error: Please check your internet connection and try again.';
                } else {
                    errorMsg = 'Error: ' + (error.message || 'Something went wrong. Please try again.');
                }
                
                errorMessage.textContent = errorMsg;
                
                // Add retry button to error message
                const retryButton = document.createElement('button');
                retryButton.className = 'btn btn-outline-primary mt-3';
                retryButton.innerHTML = '<i class="fas fa-redo me-1"></i> Try Again';
                retryButton.onclick = function() {
                    // Remove button
                    if (errorMessage.nextElementSibling) {
                        errorMessage.parentNode.removeChild(errorMessage.nextElementSibling);
                    }
                    
                    // Hide error and start over
                    feedbackError.style.display = 'none';
                    startOverBtn.click();
                };
                
                if (!errorMessage.nextElementSibling || !errorMessage.nextElementSibling.classList.contains('btn')) {
                    errorMessage.parentNode.appendChild(retryButton);
                }
            });
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            // Stop all camera streams
            stopCameraStream(questionStream);
            stopCameraStream(answerStream);
        });
    });
</script>
{% endblock %}
