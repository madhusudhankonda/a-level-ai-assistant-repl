{% extends 'base.html' %}

{% block title %}Feedback Management - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">
                    <i class="fas fa-comments me-2"></i>User Feedback Management
                </h1>
                <a href="{{ url_for('admin.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Admin Dashboard
                </a>
            </div>
            
            <!-- Feedback Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">Total Feedback</h5>
                            <p class="card-text display-6">{{ feedback_entries|length }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body">
                            <h5 class="card-title">Issues</h5>
                            <p class="card-text display-6">{{ feedback_entries|selectattr('feedback_type', 'equalto', 'issue')|list|length }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">Feature Requests</h5>
                            <p class="card-text display-6">{{ feedback_entries|selectattr('feedback_type', 'equalto', 'feature')|list|length }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <h5 class="card-title">General Feedback</h5>
                            <p class="card-text display-6">{{ feedback_entries|selectattr('feedback_type', 'equalto', 'general')|list|length }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Controls -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Filter Feedback</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="filterType" class="form-label">Feedback Type</label>
                            <select id="filterType" class="form-select">
                                <option value="all">All Types</option>
                                <option value="issue">Issues</option>
                                <option value="feature">Feature Requests</option>
                                <option value="general">General Feedback</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Status</label>
                            <select id="filterStatus" class="form-select">
                                <option value="all">All Statuses</option>
                                <option value="new">New</option>
                                <option value="in-review">In Review</option>
                                <option value="planned">Planned</option>
                                <option value="implemented">Implemented</option>
                                <option value="declined">Declined</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterImpact" class="form-label">Impact Level</label>
                            <select id="filterImpact" class="form-select">
                                <option value="all">All Impacts</option>
                                <option value="critical">Critical</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button id="applyFilters" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Feedback List -->
            <div class="card">
                <div class="card-header bg-gradient-purple text-white">
                    <h5 class="mb-0">Feedback Entries</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="feedbackTable" class="table table-hover align-middle mb-0">
                            <thead class="bg-dark text-white">
                                <tr>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Subject</th>
                                    <th>User</th>
                                    <th>Impact</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if feedback_entries %}
                                    {% for feedback in feedback_entries %}
                                        <tr class="feedback-item" 
                                            data-type="{{ feedback.feedback_type }}"
                                            data-status="{{ feedback.status }}"
                                            data-impact="{{ feedback.impact_level or 'none' }}">
                                            <td>{{ feedback.id }}</td>
                                            <td>
                                                {% if feedback.feedback_type == 'issue' %}
                                                    <span class="badge bg-danger">Issue</span>
                                                {% elif feedback.feedback_type == 'feature' %}
                                                    <span class="badge bg-success">Feature</span>
                                                {% else %}
                                                    <span class="badge bg-info">General</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ feedback.subject }}</td>
                                            <td>
                                                {% if feedback.user %}
                                                    <span class="user-badge">{{ feedback.user.username }}</span>
                                                {% else %}
                                                    <span class="text-muted">Anonymous</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if feedback.impact_level == 'critical' %}
                                                    <span class="badge bg-danger">Critical</span>
                                                {% elif feedback.impact_level == 'high' %}
                                                    <span class="badge bg-warning">High</span>
                                                {% elif feedback.impact_level == 'medium' %}
                                                    <span class="badge bg-primary">Medium</span>
                                                {% elif feedback.impact_level == 'low' %}
                                                    <span class="badge bg-secondary">Low</span>
                                                {% else %}
                                                    <span class="text-muted">Not specified</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ feedback.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td>
                                                {% if feedback.status == 'new' %}
                                                    <span class="badge bg-info">New</span>
                                                {% elif feedback.status == 'in-review' %}
                                                    <span class="badge bg-warning">In Review</span>
                                                {% elif feedback.status == 'planned' %}
                                                    <span class="badge bg-primary">Planned</span>
                                                {% elif feedback.status == 'implemented' %}
                                                    <span class="badge bg-success">Implemented</span>
                                                {% elif feedback.status == 'declined' %}
                                                    <span class="badge bg-secondary">Declined</span>
                                                {% else %}
                                                    <span class="badge bg-light text-dark">Unknown</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-info view-feedback" data-id="{{ feedback.id }}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-primary update-status" data-id="{{ feedback.id }}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <p class="mb-2 text-muted">No feedback entries found.</p>
                                            <p class="small text-muted">When users submit feedback, it will appear here.</p>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Feedback Detail Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="feedbackModalLabel">Feedback Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="feedbackDetails">
                    <!-- Will be populated with AJAX -->
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="updateStatusBtn" type="button" class="btn btn-primary">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="statusModalLabel">Update Feedback Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="statusUpdateForm">
                    <input type="hidden" id="feedbackId" name="feedbackId" value="">
                    
                    <div class="mb-3">
                        <label for="feedbackStatus" class="form-label">Status</label>
                        <select id="feedbackStatus" name="status" class="form-select" required>
                            <option value="new">New</option>
                            <option value="in-review">In Review</option>
                            <option value="planned">Planned</option>
                            <option value="implemented">Implemented</option>
                            <option value="declined">Declined</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="adminNotes" class="form-label">Admin Notes</label>
                        <textarea id="adminNotes" name="adminNotes" class="form-control" rows="3" placeholder="Internal notes about this feedback (not visible to users)"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="adminResponse" class="form-label">Response to User</label>
                        <textarea id="adminResponse" name="adminResponse" class="form-control" rows="3" placeholder="Response to send to the user (if applicable)"></textarea>
                        <div class="form-text">
                            This response may be sent to the user via email if they requested notification.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="saveStatus" type="button" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter functionality
        const filterType = document.getElementById('filterType');
        const filterStatus = document.getElementById('filterStatus');
        const filterImpact = document.getElementById('filterImpact');
        const applyFilters = document.getElementById('applyFilters');
        const feedbackItems = document.querySelectorAll('.feedback-item');
        
        // Elements for the detail modal
        const feedbackModal = document.getElementById('feedbackModal');
        const feedbackDetails = document.getElementById('feedbackDetails');
        const updateStatusBtn = document.getElementById('updateStatusBtn');
        
        // Elements for status update modal
        const statusModal = document.getElementById('statusModal');
        const feedbackIdInput = document.getElementById('feedbackId');
        const feedbackStatusSelect = document.getElementById('feedbackStatus');
        const adminNotesTextarea = document.getElementById('adminNotes');
        const adminResponseTextarea = document.getElementById('adminResponse');
        const saveStatusBtn = document.getElementById('saveStatus');
        
        // Current feedback ID for operations
        let currentFeedbackId = null;
        
        // Apply filters
        applyFilters.addEventListener('click', function() {
            const typeValue = filterType.value;
            const statusValue = filterStatus.value;
            const impactValue = filterImpact.value;
            
            feedbackItems.forEach(item => {
                const matchesType = typeValue === 'all' || item.dataset.type === typeValue;
                const matchesStatus = statusValue === 'all' || item.dataset.status === statusValue;
                const matchesImpact = impactValue === 'all' || item.dataset.impact === impactValue;
                
                if (matchesType && matchesStatus && matchesImpact) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // View feedback details
        const viewButtons = document.querySelectorAll('.view-feedback');
        const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        const feedbackDetails = document.getElementById('feedbackDetails');
        
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const feedbackId = this.dataset.id;
                // Placeholder for AJAX call to get feedback details
                // In a real implementation, this would fetch the feedback details from the server
                feedbackDetails.innerHTML = `
                    <div class="mb-4">
                        <h4 class="mb-3">Feedback #${feedbackId}</h4>
                        <p class="text-muted">Placeholder for feedback details that would be loaded via AJAX.</p>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5>Feedback Type</h5>
                            <p>Issue</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Impact Level</h5>
                            <p>High</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h5>Subject</h5>
                        <p>Example subject for feedback #${feedbackId}</p>
                    </div>
                    <div class="mb-3">
                        <h5>Feedback Text</h5>
                        <p>This is a placeholder for the feedback text that would be loaded from the server. The actual feedback would be displayed here.</p>
                    </div>
                    <div class="mb-3">
                        <h5>User Information</h5>
                        <p>Username: example_user</p>
                        <p>Email: user@example.com</p>
                    </div>
                    <div class="mb-3">
                        <h5>Browser Information</h5>
                        <p class="text-muted small">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36</p>
                    </div>
                    <div class="mb-3">
                        <h5>Screenshot</h5>
                        <p class="text-muted">No screenshot provided</p>
                    </div>
                `;
                
                feedbackModal.show();
            });
        });
        
        // Update status
        const updateButtons = document.querySelectorAll('.update-status');
        const updateStatusBtn = document.getElementById('updateStatusBtn');
        const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
        const feedbackIdInput = document.getElementById('feedbackId');
        
        updateButtons.forEach(button => {
            button.addEventListener('click', function() {
                const feedbackId = this.dataset.id;
                feedbackIdInput.value = feedbackId;
                statusModal.show();
            });
        });
        
        updateStatusBtn.addEventListener('click', function() {
            const feedbackId = feedbackDetails.querySelector('h4').textContent.split('#')[1];
            feedbackIdInput.value = feedbackId;
            feedbackModal.hide();
            statusModal.show();
        });
        
        // Save status changes
        const saveStatusBtn = document.getElementById('saveStatus');
        saveStatusBtn.addEventListener('click', function() {
            // Placeholder for AJAX call to update status
            // In a real implementation, this would send the form data to the server
            alert('Status update functionality would be implemented with AJAX');
            statusModal.hide();
        });
    });
</script>
{% endblock %}